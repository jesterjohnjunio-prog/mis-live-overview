<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIS Services Live Overview Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .dashboard-header {
            background: linear-gradient(90deg, #2c5282, #4a6fa5, #667eea);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .dashboard-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .dashboard-header .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-dot.live { background-color: #38a169; animation: pulse 2s infinite; }
        .status-dot.loading { background-color: #d69e2e; }
        .status-dot.error { background-color: #e53e3e; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Overview Section */
        .overview-summary {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .overview-title {
            font-size: 1.8rem;
            color: #2c5282;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .refresh-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #2c5282;
        }
        
        .auto-refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #38a169;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .services-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .service-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-top: 5px solid;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }
        
        .service-card.ict {
            border-color: #4a6fa5;
        }
        
        .service-card.technical {
            border-color: #e74c3c;
        }
        
        .service-card.website {
            border-color: #f1c40f;
        }
        
        .service-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .service-icon {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: transparent;
        }
        
        .lottie-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .service-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c5282;
        }
        
        .service-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .service-stat {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .service-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .service-stat-label {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .performance-score {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a6fa5, #2c5282);
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .service-links {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }
        
        .service-link {
            padding: 8px 15px;
            background: #f1f5f9;
            border-radius: 6px;
            text-decoration: none;
            color: #4a5568;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }
        
        .service-link:hover {
            background: #e2e8f0;
        }
        
        .service-link.primary {
            background: #4a6fa5;
            color: white;
        }
        
        .service-link.primary:hover {
            background: #2c5282;
        }
        
        .service-status {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Overall Summary Stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .summary-stat {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .summary-stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-stat-label {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .summary-stat-value.tickets { color: #2c5282; }
        .summary-stat-value.rating { color: #38a169; }
        .summary-stat-value.response { color: #e53e3e; }
        
        /* Performance Chart */
        .performance-section {
            padding: 30px;
        }
        
        .performance-title {
            font-size: 1.8rem;
            color: #2c5282;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .performance-chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f1f5f9;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        /* Loading and Error States */
        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #64748b;
            text-align: center;
        }
        
        .loading-spinner {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #4a6fa5;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #e53e3e;
            text-align: center;
            background: #fed7d7;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        /* Last Updated */
        .last-updated {
            text-align: center;
            padding: 15px;
            color: #94a3b8;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        /* Footer */
        .dashboard-footer {
            text-align: center;
            padding: 25px;
            color: #94a3b8;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .services-overview {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 2rem;
            }
            
            .overview-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .refresh-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .services-overview {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                height: 250px;
            }
        }
        
        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .service-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-chart-network"></i> MIS Services Live Overview</h1>
            <p>Real-time monitoring of ICT Concerns, Technical Assistance, and Website Updates services</p>
            <div class="status-indicator">
                <div><span class="status-dot live"></span> Live Connection</div>
                <div><span class="status-dot loading"></span> Loading Data</div>
                <div><span class="status-dot error"></span> Error</div>
            </div>
        </div>
        
        <div class="overview-summary">
            <h2 class="overview-title">
                <i class="fas fa-tachometer-alt"></i> Services Performance Dashboard
                <div class="refresh-controls">
                    <div class="auto-refresh-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoRefreshToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span>Auto-refresh (5 min)</span>
                    </div>
                    <button class="refresh-btn" onclick="loadAllServicesData()">
                        <i class="fas fa-redo-alt"></i> Refresh Now
                    </button>
                </div>
            </h2>
            
            <div class="services-overview">
                <!-- ICT Concerns Card -->
                <div class="service-card ict">
                    <div class="service-status">
                        <span class="status-dot" id="ictStatus"></span>
                        <span id="ictStatusText">Loading...</span>
                    </div>
                    <div class="service-header">
                        <div>
                            <div class="service-title">ICT Concerns</div>
                            <div style="font-size: 0.9rem; color: #64748b;"> </div>
                        </div>
                        <div class="service-icon">
                            <div class="lottie-container" id="ictLottie"></div>
                        </div>
                    </div>
                    
                    <div class="service-stats">
                        <div class="service-stat">
                            <div class="service-stat-value" id="ictTickets">0</div>
                            <div class="service-stat-label">Closed Tickets</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="ictPerformance">0.0</div>
                            <div class="service-stat-label">Avg Rating</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="ictResponse">0.0h</div>
                            <div class="service-stat-label">Avg Response</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="ictPersonnel">0</div>
                            <div class="service-stat-label">Personnel</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
                        <div class="performance-score" id="ictScore">0.0</div>
                        <div>
                            <div style="font-weight: 600; color: #2c5282;">Overall Performance</div>
                            <div style="font-size: 0.85rem; color: #718096;">Combined score out of 10</div>
                        </div>
                    </div>
                    
                    <div class="service-links">
                        <a href="https://sites.google.com/ro.mwss.gov.ph/mwssromisportal/mis-performance/ict-concerns" 
                           target="_blank" class="service-link primary">
                            <i class="fas fa-external-link-alt"></i> View Performance Portal
                        </a>
                    </div>
                </div>
                
                <!-- Technical Assistance Card -->
                <div class="service-card technical">
                    <div class="service-status">
                        <span class="status-dot" id="techStatus"></span>
                        <span id="techStatusText">Loading...</span>
                    </div>
                    <div class="service-header">
                        <div>
                            <div class="service-title">Technical Assistance</div>
                            <div style="font-size: 0.9rem; color: #64748b;"> </div>
                        </div>
                        <div class="service-icon">
                            <div class="lottie-container" id="techLottie"></div>
                        </div>
                    </div>
                    
                    <div class="service-stats">
                        <div class="service-stat">
                            <div class="service-stat-value" id="techTickets">0</div>
                            <div class="service-stat-label">Closed Tickets</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="techPerformance">0.0</div>
                            <div class="service-stat-label">Avg Rating</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="techResponse">0.0h</div>
                            <div class="service-stat-label">Avg Response</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="techPersonnel">0</div>
                            <div class="service-stat-label">Personnel</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
                        <div class="performance-score" id="techScore">0.0</div>
                        <div>
                            <div style="font-weight: 600; color: #2c5282;">Overall Performance</div>
                            <div style="font-size: 0.85rem; color: #718096;">Combined score out of 10</div>
                        </div>
                    </div>
                    
                    <div class="service-links">
                        <a href="https://sites.google.com/ro.mwss.gov.ph/mwssromisportal/mis-performance/technical-assistance" 
                           target="_blank" class="service-link primary">
                            <i class="fas fa-external-link-alt"></i> View Performance Portal
                        </a>
                    </div>
                </div>
                
                <!-- Website Updates Card -->
                <div class="service-card website">
                    <div class="service-status">
                        <span class="status-dot" id="webStatus"></span>
                        <span id="webStatusText">Loading...</span>
                    </div>
                    <div class="service-header">
                        <div>
                            <div class="service-title">Website Updates</div>
                            <div style="font-size: 0.9rem; color: #64748b;"> </div>
                        </div>
                        <div class="service-icon">
                            <div class="lottie-container" id="webLottie"></div>
                        </div>
                    </div>
                    
                    <div class="service-stats">
                        <div class="service-stat">
                            <div class="service-stat-value" id="webTickets">0</div>
                            <div class="service-stat-label">Closed Tickets</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="webPerformance">0.0</div>
                            <div class="service-stat-label">Avg Rating</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="webResponse">0.0h</div>
                            <div class="service-stat-label">Avg Response</div>
                        </div>
                        <div class="service-stat">
                            <div class="service-stat-value" id="webPersonnel">0</div>
                            <div class="service-stat-label">Personnel</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
                        <div class="performance-score" id="webScore">0.0</div>
                        <div>
                            <div style="font-weight: 600; color: #2c5282;">Overall Performance</div>
                            <div style="font-size: 0.85rem; color: #718096;">Combined score out of 10</div>
                        </div>
                    </div>
                    
                    <div class="service-links">
                        <a href="https://sites.google.com/ro.mwss.gov.ph/mwssromisportal/mis-performance/website-updates" 
                           target="_blank" class="service-link primary">
                            <i class="fas fa-external-link-alt"></i> View Performance Portal
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Overall Summary Stats -->
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value tickets" id="totalTickets">0</div>
                    <div class="summary-stat-label">Total Rated Tickets</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value rating" id="avgRating">0.0</div>
                    <div class="summary-stat-label">Average Rating (All Services)</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value response" id="avgResponse">0.0h</div>
                    <div class="summary-stat-label">Average Response Time</div>
                </div>
            </div>
            
            <!-- Error Display Area -->
            <div id="errorDisplay" class="error-overlay" style="display: none;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px;"></i>
                <h3>Error Loading Data</h3>
                <p id="errorMessage">Unable to fetch data from Google Sheets. Please check your connection.</p>
            </div>
        </div>
        
        <!-- Performance Chart Section -->
        <div class="performance-section">
            <h2 class="performance-title"><i class="fas fa-chart-line"></i> Performance Comparison</h2>
            <div class="performance-chart-container">
                <div class="chart-container" id="performanceChart"></div>
                <div class="legend" id="performanceLegend"></div>
            </div>
        </div>
        
        <!-- Last Updated -->
        <div class="last-updated">
            Last Updated: <span id="lastUpdated">Loading...</span> | 
            Auto-refresh: <span id="nextRefresh">5:00</span>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner"></i>
            </div>
            <h2>Loading Services Data</h2>
            <p>Fetching live data from Google Sheets...</p>
            <div style="margin-top: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span class="status-dot" id="ictLoadStatus"></span>
                    <span>ICT Concerns: <span id="ictLoadText">Pending</span></span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span class="status-dot" id="techLoadStatus"></span>
                    <span>Technical Assistance: <span id="techLoadText">Pending</span></span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="status-dot" id="webLoadStatus"></span>
                    <span>Website Updates: <span id="webLoadText">Pending</span></span>
                </div>
            </div>
        </div>
        
        <div class="dashboard-footer">
            <p><strong>MIS Services Live Overview Dashboard</strong> | Data fetched directly from Google Sheets</p>
            <p>Sheets automatically update every 5 minutes when changes are detected</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            refreshInterval: 5 * 60 * 1000, // 5 minutes in milliseconds
            corsProxy: 'https://api.allorigins.win/raw?url=', // CORS proxy
            services: {
                ict: {
                    name: 'ICT Concerns',
                    color: '#4a6fa5',
                    lottieUrl: 'https://assets5.lottiefiles.com/packages/lf20_9Ia5VaAqET.json',
                    // Using CSV format URL
                    sheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlQLcK_Ktw2zemNHDZ_70giWPqT54Mvoci_dJxQz1RWYhe94UaDQLPQU89DUYLTY-ow7s2sWa-PB0h/pub?gid=1210338777&single=true&output=csv',
                    performanceRatingCol: 12, // Column M (0-indexed: 12)
                    responseTimeCol: 10,      // Column K (0-indexed: 10)
                    personnelCol: 9           // Column J (0-indexed: 9)
                },
                technical: {
                    name: 'Technical Assistance',
                    color: '#e74c3c',
                    lottieUrl: 'https://assets8.lottiefiles.com/packages/lf20_H2CCWIwGfv.json',
                    // Using CSV format URL
                    sheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vThsYnoHcRAZyAb4Jwa4Z8xLuSo4KUAlW32rq36auU65r_19qlXdaGd69hUj8eyQsK0XHC2F2ks7gIR/pub?gid=1593164427&single=true&output=csv',
                    performanceRatingCol: 12, // Column M (0-indexed: 12)
                    responseTimeCol: 10,      // Column K (0-indexed: 10)
                    personnelCol: 9           // Column J (0-indexed: 9)
                },
                website: {
                    name: 'Website Updates',
                    color: '#f1c40f',
                    lottieUrl: 'https://assets7.lottiefiles.com/packages/lf20_zF6V71NMlh.json',
                    // Already has CSV format
                    sheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLmIeIOdtDoDMI0WOMYMjsa77L2S-gF9OyL7eyLvbnGJatNeFDHRgiN5qLZPhYEDsUx1wINXebriLT/pub?gid=744987615&single=true&output=csv',
                    performanceRatingCol: 11, // Column L (0-indexed: 11)
                    responseTimeCol: 9,       // Column J (0-indexed: 9)
                    personnelCol: 8           // Column I (0-indexed: 8)
                }
            }
        };
        
        // Data storage
        let servicesData = {
            ict: { status: 'loading', data: null, lastUpdated: null, error: null },
            technical: { status: 'loading', data: null, lastUpdated: null, error: null },
            website: { status: 'loading', data: null, lastUpdated: null, error: null }
        };
        
        let autoRefreshInterval = null;
        let nextRefreshTime = null;
        let lottieAnimations = {};
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Set up auto-refresh toggle
            const autoRefreshToggle = document.getElementById('autoRefreshToggle');
            autoRefreshToggle.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            // Initialize status indicators
            updateServiceStatusUI('ict', 'loading');
            updateServiceStatusUI('technical', 'loading');
            updateServiceStatusUI('website', 'loading');
            
            // Load Lottie animations
            loadLottieAnimations();
            
            // Load data for all services
            loadAllServicesData();
            
            // Start auto-refresh by default
            startAutoRefresh();
            
            // Set up refresh countdown
            updateRefreshCountdown();
            setInterval(updateRefreshCountdown, 1000);
        });
        
        // Load Lottie animations
        function loadLottieAnimations() {
            // ICT Concerns animation
            lottieAnimations.ict = lottie.loadAnimation({
                container: document.getElementById('ictLottie'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: CONFIG.services.ict.lottieUrl
            });
            
            // Technical Assistance animation
            lottieAnimations.technical = lottie.loadAnimation({
                container: document.getElementById('techLottie'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: CONFIG.services.technical.lottieUrl
            });
            
            // Website Updates animation
            lottieAnimations.website = lottie.loadAnimation({
                container: document.getElementById('webLottie'),
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: CONFIG.services.website.lottieUrl
            });
        }
        
        // Load data for all services
        async function loadAllServicesData() {
            showLoadingOverlay();
            clearErrors();
            
            try {
                // Update loading status - use correct IDs
                updateLoadStatus('ict', 'loading');
                updateLoadStatus('technical', 'loading');
                updateLoadStatus('website', 'loading');
                
                // Load data for each service in parallel
                await Promise.allSettled([
                    loadServiceData('ict'),
                    loadServiceData('technical'),
                    loadServiceData('website')
                ]);
                
                // Update the UI with the fetched data
                updateDashboardUI();
                createPerformanceChart();
                
                // Hide loading overlay
                setTimeout(() => {
                    hideLoadingOverlay();
                }, 500);
                
                // Update timestamp
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading services data:', error);
                showError('Failed to load services data: ' + error.message);
                hideLoadingOverlay();
            }
        }
        
        // Load data for a specific service
        async function loadServiceData(serviceId) {
            const service = CONFIG.services[serviceId];
            
            try {
                // Update status
                servicesData[serviceId].status = 'loading';
                updateServiceStatusUI(serviceId, 'loading');
                updateLoadStatus(serviceId, 'loading');
                
                // Fetch CSV data from Google Sheets
                const csvUrl = CONFIG.corsProxy + encodeURIComponent(service.sheetUrl);
                console.log(`Loading ${service.name} data from:`, csvUrl);
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Empty response from Google Sheets');
                }
                
                // Parse CSV data
                const tickets = parseCSVData(csvText, serviceId);
                
                // Analyze the data
                const analysis = analyzeServiceData(tickets, serviceId);
                
                // Store the data
                servicesData[serviceId].data = analysis;
                servicesData[serviceId].lastUpdated = new Date();
                servicesData[serviceId].status = 'success';
                servicesData[serviceId].error = null;
                
                // Update UI status
                updateServiceStatusUI(serviceId, 'success');
                updateLoadStatus(serviceId, 'success');
                
                console.log(`Successfully loaded ${service.name}:`, analysis);
                
            } catch (error) {
                console.error(`Error loading ${service.name} data:`, error);
                
                // Store error
                servicesData[serviceId].status = 'error';
                servicesData[serviceId].error = error.message;
                
                // Update UI status
                updateServiceStatusUI(serviceId, 'error');
                updateLoadStatus(serviceId, 'error');
                
                // Show error in the dashboard
                showError(`${service.name}: ${error.message}`);
            }
        }
        
        // Parse CSV data with correct column mappings
        function parseCSVData(csvText, serviceId) {
            const rows = csvText.split('\n');
            const tickets = [];
            const service = CONFIG.services[serviceId];
            
            console.log(`${service.name} - Total rows: ${rows.length}`);
            
            // Skip header row
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].trim() === '') continue;
                
                const cols = parseCSVRow(rows[i]);
                
                // Debug: log first few rows to check column structure
                if (i <= 3) {
                    console.log(`${service.name} - Row ${i} columns:`, cols);
                    console.log(`${service.name} - Rating col ${service.performanceRatingCol}:`, cols[service.performanceRatingCol]);
                    console.log(`${service.name} - Response col ${service.responseTimeCol}:`, cols[service.responseTimeCol]);
                }
                
                // Check if we have enough columns
                if (cols.length > Math.max(service.performanceRatingCol, service.responseTimeCol, service.personnelCol)) {
                    // Get performance rating
                    const performanceRating = parseFloat(cols[service.performanceRatingCol]) || 0;
                    
                    // Skip tickets without performance rating
                    if (performanceRating <= 0) continue;
                    
                    // Get response time text
                    const responseTimeText = cols[service.responseTimeCol] || '';
                    
                    // Get personnel name
                    const personnel = cols[service.personnelCol] || '';
                    
                    const ticket = {
                        personnel: personnel,
                        responseTimeText: responseTimeText,
                        performanceRating: performanceRating
                    };
                    
                    tickets.push(ticket);
                } else {
                    console.log(`${service.name} - Row ${i} doesn't have enough columns. Found: ${cols.length}, Need at least: ${Math.max(service.performanceRatingCol, service.responseTimeCol, service.personnelCol) + 1}`);
                }
            }
            
            console.log(`Parsed ${tickets.length} tickets for ${service.name}`);
            return tickets;
        }
        
        // Parse CSV row with proper handling of quoted fields
        function parseCSVRow(row) {
            const cols = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cols.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            cols.push(current.trim());
            return cols;
        }
        
        // Analyze service data
        function analyzeServiceData(tickets, serviceId) {
            console.log(`${CONFIG.services[serviceId].name} - Analyzing ${tickets.length} tickets`);
            
            if (tickets.length === 0) {
                console.log(`${CONFIG.services[serviceId].name} - No tickets found with ratings`);
                return {
                    totalTickets: 0,
                    avgPerformance: 0,
                    avgResponseTime: 0,
                    personnelCount: 0,
                    overallScore: 0,
                    personnel: []
                };
            }
            
            // Response time mapping
            const responseTimeMapping = {
                'Less than one (1) hour': 0.5,
                'Within the day': 4.5,
                'The next day': 12,
                'More than two (2) days': 24,
                'Less than one hour': 0.5,
                'Within the day (1-8 hrs)': 4.5,
                'The next day (8-16 hrs)': 12,
                'More than 2 days': 24,
                'More than two days': 24
            };
            
            // Convert response time text to numeric value
            function convertResponseTimeToNumeric(responseTimeText) {
                if (!responseTimeText) return 0;
                
                const normalizedText = responseTimeText.trim();
                
                if (responseTimeMapping[normalizedText]) {
                    return responseTimeMapping[normalizedText];
                }
                
                for (const [key, value] of Object.entries(responseTimeMapping)) {
                    if (normalizedText.toLowerCase().includes(key.toLowerCase())) {
                        return value;
                    }
                }
                
                // Try to extract numeric value from text
                const hourMatch = normalizedText.match(/(\d+(\.\d+)?)\s*hours?/i);
                if (hourMatch) {
                    return parseFloat(hourMatch[1]);
                }
                
                const dayMatch = normalizedText.match(/(\d+(\.\d+)?)\s*days?/i);
                if (dayMatch) {
                    return parseFloat(dayMatch[1]) * 24;
                }
                
                return 0;
            }
            
            // Calculate combined performance score
            function calculateCombinedScore(averagePerformance, averageResponseTime) {
                // Performance rating component (0-5 scale, converted to 0-5 points)
                const performanceScore = averagePerformance;
                
                // Response time component (lower is better, converted to 0-5 points)
                let responseScore = 0;
                if (averageResponseTime > 0) {
                    // Inverse relationship: lower response time = higher score
                    responseScore = Math.max(0, 5 - (averageResponseTime / 5));
                    // Cap the response score at 5
                    responseScore = Math.min(5, responseScore);
                }
                
                // Combined score (weighted average)
                // Performance weight: 60%, Response time weight: 40%
                const combinedScore = (performanceScore * 0.6) + (responseScore * 0.4);
                
                return Math.min(10, combinedScore * 2); // Scale to 0-10
            }
            
            // Track personnel performance
            const personnelMap = {};
            let totalPerformance = 0;
            let totalResponseTime = 0;
            let validResponseTimeCount = 0;
            
            tickets.forEach(ticket => {
                // Track personnel
                if (ticket.personnel && ticket.personnel.trim() !== '') {
                    if (!personnelMap[ticket.personnel]) {
                        personnelMap[ticket.personnel] = {
                            name: ticket.personnel,
                            performanceSum: 0,
                            responseTimeSum: 0,
                            ticketCount: 0,
                            responseTimeCount: 0
                        };
                    }
                    
                    const personnel = personnelMap[ticket.personnel];
                    personnel.performanceSum += ticket.performanceRating;
                    personnel.ticketCount++;
                    
                    // Track response time
                    const responseTime = convertResponseTimeToNumeric(ticket.responseTimeText);
                    if (responseTime > 0) {
                        personnel.responseTimeSum += responseTime;
                        personnel.responseTimeCount++;
                        
                        totalResponseTime += responseTime;
                        validResponseTimeCount++;
                    }
                }
                
                totalPerformance += ticket.performanceRating;
            });
            
            // Calculate averages
            const avgPerformance = totalPerformance / tickets.length;
            const avgResponseTime = validResponseTimeCount > 0 ? totalResponseTime / validResponseTimeCount : 0;
            const overallScore = calculateCombinedScore(avgPerformance, avgResponseTime);
            
            console.log(`${CONFIG.services[serviceId].name} - Analysis results:`, {
                totalTickets: tickets.length,
                avgPerformance: avgPerformance,
                avgResponseTime: avgResponseTime,
                personnelCount: Object.keys(personnelMap).length,
                overallScore: overallScore
            });
            
            // Convert personnel map to array and calculate individual scores
            const personnelArray = Object.values(personnelMap).map(personnel => {
                const avgPersonnelPerformance = personnel.ticketCount > 0 ? 
                    personnel.performanceSum / personnel.ticketCount : 0;
                
                const avgPersonnelResponseTime = personnel.responseTimeCount > 0 ?
                    personnel.responseTimeSum / personnel.responseTimeCount : 0;
                
                const personnelScore = calculateCombinedScore(avgPersonnelPerformance, avgPersonnelResponseTime);
                
                return {
                    name: personnel.name,
                    score: personnelScore,
                    avgPerformance: avgPersonnelPerformance,
                    avgResponseTime: avgPersonnelResponseTime,
                    ticketCount: personnel.ticketCount
                };
            });
            
            return {
                totalTickets: tickets.length,
                avgPerformance: avgPerformance,
                avgResponseTime: avgResponseTime,
                personnelCount: Object.keys(personnelMap).length,
                overallScore: overallScore,
                personnel: personnelArray
            };
        }
        
        // Update the dashboard UI with fetched data
        function updateDashboardUI() {
            // Update each service card
            for (const [serviceId, serviceData] of Object.entries(servicesData)) {
                const analysis = serviceData.data;
                
                if (analysis) {
                    // Map service ID to HTML element IDs
                    let elementPrefix;
                    switch(serviceId) {
                        case 'ict': elementPrefix = 'ict'; break;
                        case 'technical': elementPrefix = 'tech'; break;
                        case 'website': elementPrefix = 'web'; break;
                        default: elementPrefix = serviceId;
                    }
                    
                    // Update service card
                    document.getElementById(`${elementPrefix}Tickets`).textContent = analysis.totalTickets;
                    document.getElementById(`${elementPrefix}Performance`).textContent = analysis.avgPerformance.toFixed(1);
                    document.getElementById(`${elementPrefix}Response`).textContent = analysis.avgResponseTime.toFixed(1) + 'h';
                    document.getElementById(`${elementPrefix}Personnel`).textContent = analysis.personnelCount;
                    document.getElementById(`${elementPrefix}Score`).textContent = analysis.overallScore.toFixed(1);
                    
                    // Update service status
                    updateServiceStatusUI(serviceId, 'success');
                } else {
                    // Map service ID to HTML element IDs
                    let elementPrefix;
                    switch(serviceId) {
                        case 'ict': elementPrefix = 'ict'; break;
                        case 'technical': elementPrefix = 'tech'; break;
                        case 'website': elementPrefix = 'web'; break;
                        default: elementPrefix = serviceId;
                    }
                    
                    // No data available
                    document.getElementById(`${elementPrefix}Tickets`).textContent = '0';
                    document.getElementById(`${elementPrefix}Performance`).textContent = '0.0';
                    document.getElementById(`${elementPrefix}Response`).textContent = '0.0h';
                    document.getElementById(`${elementPrefix}Personnel`).textContent = '0';
                    document.getElementById(`${elementPrefix}Score`).textContent = '0.0';
                    
                    updateServiceStatusUI(serviceId, serviceData.status);
                }
            }
            
            // Calculate and update overall summary stats
            let totalTickets = 0;
            let totalWeightedPerformance = 0;
            let totalWeightedResponseTime = 0;
            // Removed: let totalPersonnel = 0;
            
            for (const [serviceId, serviceData] of Object.entries(servicesData)) {
                const analysis = serviceData.data;
                
                if (analysis && analysis.totalTickets > 0) {
                    totalTickets += analysis.totalTickets;
                    totalWeightedPerformance += analysis.avgPerformance * analysis.totalTickets;
                    totalWeightedResponseTime += analysis.avgResponseTime * analysis.totalTickets;
                    // Removed: totalPersonnel += analysis.personnelCount;
                }
            }
            
            // Update overall stats
            document.getElementById('totalTickets').textContent = totalTickets;
            
            if (totalTickets > 0) {
                const avgRating = totalWeightedPerformance / totalTickets;
                const avgResponse = totalWeightedResponseTime / totalTickets;
                
                document.getElementById('avgRating').textContent = avgRating.toFixed(1);
                document.getElementById('avgResponse').textContent = avgResponse.toFixed(1) + 'h';
            } else {
                document.getElementById('avgRating').textContent = '0.0';
                document.getElementById('avgResponse').textContent = '0.0h';
            }
            // Removed: document.getElementById('totalPersonnel').textContent = totalPersonnel;
        }
        
        // Update service status UI
        function updateServiceStatusUI(serviceId, status) {
            // Map service ID to HTML element IDs
            let elementId;
            switch(serviceId) {
                case 'ict': elementId = 'ict'; break;
                case 'technical': elementId = 'tech'; break;
                case 'website': elementId = 'web'; break;
                default: elementId = serviceId;
            }
            
            const statusElement = document.getElementById(`${elementId}Status`);
            const statusTextElement = document.getElementById(`${elementId}StatusText`);
            
            if (!statusElement || !statusTextElement) {
                console.warn(`Status elements for ${serviceId} (${elementId}) not found`);
                return;
            }
            
            // Remove all status classes
            statusElement.className = 'status-dot'; // Reset to base class
            
            // Set appropriate class and text
            switch(status) {
                case 'success':
                    statusElement.classList.add('live');
                    statusTextElement.textContent = 'Live';
                    break;
                case 'loading':
                    statusElement.classList.add('loading');
                    statusTextElement.textContent = 'Loading...';
                    break;
                case 'error':
                    statusElement.classList.add('error');
                    statusTextElement.textContent = 'Error';
                    break;
                default:
                    statusElement.classList.add('loading');
                    statusTextElement.textContent = 'Loading...';
            }
        }
        
        // Update load status in loading overlay
        function updateLoadStatus(serviceId, status) {
            // Map service IDs to the DOM element IDs used in the HTML
            const serviceElementMap = {
                'ict': 'ict',
                'technical': 'tech', // HTML uses 'tech' not 'technical'
                'website': 'web'     // HTML uses 'web' not 'website'
            };
            
            const elementId = serviceElementMap[serviceId];
            if (!elementId) return;
            
            const loadStatusElement = document.getElementById(`${elementId}LoadStatus`);
            const loadTextElement = document.getElementById(`${elementId}LoadText`);
            
            if (!loadStatusElement || !loadTextElement) {
                console.warn(`Elements for ${serviceId} not found in DOM`);
                return;
            }
            
            // Remove all status classes
            loadStatusElement.className = 'status-dot'; // Reset to base class
            
            // Set appropriate class and text
            switch(status) {
                case 'success':
                    loadStatusElement.classList.add('live');
                    loadTextElement.textContent = 'Loaded';
                    break;
                case 'loading':
                    loadStatusElement.classList.add('loading');
                    loadTextElement.textContent = 'Loading...';
                    break;
                case 'error':
                    loadStatusElement.classList.add('error');
                    loadTextElement.textContent = 'Error';
                    break;
                default:
                    loadStatusElement.classList.add('loading');
                    loadTextElement.textContent = 'Pending';
            }
        }
        
        // Show loading overlay
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        // Hide loading overlay
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorDisplay.style.display = 'block';
            
            // Auto-hide error after 10 seconds
            setTimeout(() => {
                errorDisplay.style.display = 'none';
            }, 10000);
        }
        
        // Clear all errors
        function clearErrors() {
            document.getElementById('errorDisplay').style.display = 'none';
        }
        
        // Create performance comparison chart
        function createPerformanceChart() {
            const container = document.getElementById('performanceChart');
            container.innerHTML = '';
            
            const margin = { top: 20, right: 30, bottom: 50, left: 60 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;
            
            const svg = d3.select('#performanceChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Prepare data for the chart
            const chartData = [];
            
            for (const [serviceId, serviceData] of Object.entries(servicesData)) {
                const analysis = serviceData.data;
                const service = CONFIG.services[serviceId];
                
                if (analysis && analysis.totalTickets > 0) {
                    chartData.push({
                        service: service.name,
                        score: analysis.overallScore,
                        color: service.color,
                        tickets: analysis.totalTickets,
                        rating: analysis.avgPerformance
                    });
                }
            }
            
            // If no services have data, show empty state
            if (chartData.length === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .text('No data available')
                    .style('fill', '#64748b')
                    .style('font-size', '16px');
                
                document.getElementById('performanceLegend').innerHTML = `
                    <div class="legend-item">
                        <span>No service data available. Please check your connections.</span>
                    </div>
                `;
                return;
            }
            
            // X scale
            const x = d3.scaleBand()
                .domain(chartData.map(d => d.service))
                .range([0, width])
                .padding(0.3);
            
            // Y scale
            const y = d3.scaleLinear()
                .domain([0, 10])
                .nice()
                .range([height, 0]);
            
            // Add X axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x));
            
            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(y));
            
            // Add bars
            svg.selectAll('.performance-bar')
                .data(chartData)
                .enter()
                .append('rect')
                .attr('class', 'performance-bar')
                .attr('x', d => x(d.service))
                .attr('y', d => y(d.score))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d.score))
                .attr('fill', d => d.color)
                .attr('rx', 4)
                .attr('ry', 4);
            
            // Add value labels
            svg.selectAll('.performance-label')
                .data(chartData)
                .enter()
                .append('text')
                .attr('class', 'performance-label')
                .attr('x', d => x(d.service) + x.bandwidth() / 2)
                .attr('y', d => y(d.score) - 10)
                .attr('text-anchor', 'middle')
                .text(d => d.score.toFixed(1))
                .style('font-weight', 'bold')
                .style('fill', '#2c5282');
            
            // Add X axis label
            svg.append('text')
                .attr('transform', `translate(${width/2},${height + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .text('Service')
                .style('fill', '#64748b');
            
            // Add Y axis label
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .text('Overall Performance Score (0-10)')
                .style('fill', '#64748b');
            
            // Create legend
            const legend = document.getElementById('performanceLegend');
            legend.innerHTML = chartData.map(item => `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${item.color};"></div>
                    <span>${item.service}: ${item.score.toFixed(1)}/10 (${item.tickets} tickets, ${item.rating.toFixed(1)}/5 avg)</span>
                </div>
            `).join('');
        }
        
        // Start auto-refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(loadAllServicesData, CONFIG.refreshInterval);
            nextRefreshTime = new Date(Date.now() + CONFIG.refreshInterval);
            console.log('Auto-refresh started');
        }
        
        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('Auto-refresh stopped');
            }
        }
        
        // Update refresh countdown
        function updateRefreshCountdown() {
            const nextRefreshElement = document.getElementById('nextRefresh');
            
            if (nextRefreshTime) {
                const now = new Date();
                const timeDiff = nextRefreshTime - now;
                
                if (timeDiff > 0) {
                    const minutes = Math.floor(timeDiff / 60000);
                    const seconds = Math.floor((timeDiff % 60000) / 1000);
                    nextRefreshElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    nextRefreshElement.textContent = 'Updating...';
                }
            } else {
                nextRefreshElement.textContent = '--:--';
            }
        }
    </script>
</body>
</html>

